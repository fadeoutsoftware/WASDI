# {{ ansible_managed }}
version: "3"

# Default project name: all containers are
# prefixed with this value
name: "wasdi"

networks:
  default:
    name: "{{ sWasdiDockerNetworkName }}"
    driver: "bridge"
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.host_binding_ipv4: "0.0.0.0"
      com.docker.network.bridge.name: "br-{{ sWasdiDockerNetworkName }}"
      com.docker.network.driver.mtu: "1500"
    external: {% if bWasdiDockerNetworkMustBeCreated %}false{% else %}true{% endif %}

    ipam:
      driver: "default"
      config:
        - subnet: "{{ sWasdiDockerNetworkSubnet }}"
          gateway: "{{ sWasdiDockerNetworkGateway }}"

services:
{% if bWasdiClientEnabled == True %}
  {{ sWasdiClientServiceName }}:
    depends_on:
      - {{ sWasdiContainerGeoserverServiceName }}
      - {{ sWasdiKeycloakServiceName }}
      - {{ sWasdiRabbitMqServiceName }}
      - {{ sWasdiContainerTomcatOgcProcessesServerServiceName }}
      - {{ sWasdiContainerTomcatWasdiOpenEoServerServiceName }}
      - {{ sWasdiContainerTomcatWasdiWebServerServiceName }}
      - {{ sWasdiTraefikServiceName }}
    image: "{{ sWasdiClientServiceName }}:latest"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.r_{{ sWasdiClientServiceName }}.entrypoints={{ sWasdiContainerTraefikEntrypoint }}"
      - "traefik.http.routers.r_{{ sWasdiClientServiceName }}.rule=Host(`{{ sWasdiContainerTraefikRuleHost }}`) && PathPrefix(`/`)"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiClientServiceName }}.middlewares=mw_wasdi-secure-denyFrame@file"
{% endif %}
      - "traefik.http.routers.r_{{ sWasdiClientServiceName }}.service=s_{{ sWasdiClientServiceName }}"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiClientServiceName }}.tls=true"
{% endif %}
      - "traefik.http.services.s_{{ sWasdiClientServiceName }}.loadbalancer.server.port={{ sWasdiClientInternalPort }}"
{% if sWasdiClientInternalPort | default("") != ""
    and sWasdiClientExternalPort | default("") != ""
    and aWasdiClientExternalIp | default([]) | length > 0 %}
    ports:
{% for sCurrentExternalIp in aWasdiClientExternalIp | sort %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiClientExternalPort }}:{{ sWasdiClientInternalPort }}"
{% endfor %}
{% endif %}
    restart: "unless-stopped"

{% endif %}
  {{ sWasdiContainerGeoserverServiceName }}:
    depends_on:
      - {{ sWasdiTraefikServiceName }}
    environment:
      - GEOSERVER_HOME={{ sWasdiGeoserverRootDirectoryPath }}/{{ sWasdiGeoserverVersion }}
      - GEOSERVER_DATA_DIR=/mnt/data_{{ sWasdiContainerGeoserverServiceName }}
{% if sWasdiContainerGeoserverEnvironmentJavaOpts | default('') != '' %}
      - JAVA_OPTS={{ sWasdiContainerGeoserverEnvironmentJavaOpts }}
{% endif %}
    image: "{{ sWasdiContainerGeoserverServiceName }}:latest"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.r_{{ sWasdiContainerGeoserverServiceName }}.entrypoints={{ sWasdiContainerTraefikEntrypoint }}"
      - "traefik.http.routers.r_{{ sWasdiContainerGeoserverServiceName }}.rule=Host(`{{ sWasdiContainerTraefikRuleHost }}`) && PathPrefix(`/geoserver`)"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiContainerGeoserverServiceName }}.middlewares=mw_wasdi-secure-denyFrame@file"
{% endif %}
      - "traefik.http.routers.r_{{ sWasdiContainerGeoserverServiceName }}.service=s_{{ sWasdiContainerGeoserverServiceName }}"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiContainerGeoserverServiceName }}.tls=true"
{% endif %}
      - "traefik.http.services.s_{{ sWasdiContainerGeoserverServiceName }}.loadbalancer.server.port={{ sWasdiContainerGeoserverInternalPort }}"
{% if sWasdiContainerGeoserverInternalPort | default("") != ""
    and sWasdiContainerGeoserverExternalPort | default("") != ""
    and aWasdiContainerGeoserverExternalIp | default([]) | length > 0 %}
    ports:
{% for sCurrentExternalIp in aWasdiContainerGeoserverExternalIp | sort %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiContainerGeoserverExternalPort }}:{{ sWasdiContainerGeoserverInternalPort }}"
{% endfor %}
{% endif %}
    restart: "unless-stopped"
    ulimits:
      nofile:
        soft: {{ sWasdiGeoserverUlimitNofile }}
        hard: {{ sWasdiGeoserverUlimitNofile }}
    volumes:
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiContainerGeoserverServiceName }}/data01:/mnt/data_{{ sWasdiContainerGeoserverServiceName }}:rw
{% if sWasdiServerTypeIsMain == True %}

  {{ sWasdiKeycloakServiceName }}:
    command:
      - "start"
{% if bWasdiKeycloakNewInstance | default(False) == True %}
      - "--import-realm"
{% endif %}
    depends_on:
      - {{ sWasdiContainerPostgresqlKeycloakServiceName }}
    entrypoint:
      - {{ sWasdiKeycloakRootDirectoryPath }}/{{ sWasdiKeycloakVersion }}/bin/kc.sh
    environment:
      - JGROUPS_DISCOVERY_EXTERNAL_IP={{ sWasdiKeycloakContainerJgroupDiscoveryExternalIp | default('127.0.0.1') }}
      - KC_CACHE_CONFIG_FILE=cache-ispn.xml
      - KC_DB_PASSWORD=${sPostgresqlKeycloakDatabasePassword}
      - KC_DB=postgres
      - KC_DB_SCHEMA=public
      - KC_DB_URL_DATABASE=keycloak
      - KC_DB_URL_HOST=wasdi-postgresql-keycloak
      - KC_DB_URL_PORT=5432
      - KC_DB_USERNAME=${sPostgresqlKeycloakDatabaseUsername}
      - KC_HEALTH_ENABLED=false
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_HTTP_ENABLED=true
      - KC_HTTP_RELATIVE_PATH=/{{ sWasdiKeycloakPathName.lstrip('/').rstrip('/') }}
      - KC_LOG_LEVEL=debug
      - KC_PROXY=edge
      - KC_TRANSACTION_XA_ENABLED=true
      - KEYCLOAK_ADMIN=${sWasdiAdministratorUsername}
      - KEYCLOAK_ADMIN_PASSWORD=${sWasdiAdministratorPassword}
    image: "{{ sWasdiKeycloakContainerImageName }}:latest"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.r_{{ sWasdiKeycloakServiceName }}.entrypoints={{ sWasdiContainerTraefikEntrypoint }}"
      - "traefik.http.routers.r_{{ sWasdiKeycloakServiceName }}.rule=Host(`{{ sWasdiContainerTraefikRuleHost }}`) && PathPrefix(`/{{ sWasdiKeycloakPathName.lstrip('/').rstrip('/') }}`)"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiKeycloakServiceName }}.middlewares=mw_wasdi-secure-allowFrame@file"
{% endif %}
      - "traefik.http.routers.r_{{ sWasdiKeycloakServiceName }}.service=s_{{ sWasdiKeycloakServiceName }}"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiKeycloakServiceName }}.tls=true"
{% endif %}
      - "traefik.http.services.s_{{ sWasdiKeycloakServiceName }}.loadbalancer.server.port={{ sWasdiKeycloakContainerInternalPort }}"
{% if sWasdiKeycloakContainerInternalPort | default("") != ""
    and sWasdiKeycloakContainerExternalPort | default("") != ""
    and aWasdiKeycloakContainerExternalIp | default([]) | length > 0 %}
    ports:
{% for sCurrentExternalIp in aWasdiKeycloakContainerExternalIp | sort %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiKeycloakContainerExternalPort }}:{{ sWasdiKeycloakContainerInternalPort }}"
{% endfor %}
{% endif %}
    restart: "unless-stopped"
    ulimits:
      nofile:
        soft: {{ sWasdiKeycloakUlimitNofile }}
        hard: {{ sWasdiKeycloakUlimitNofile }}
    volumes:
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiKeycloakServiceName }}/opt_wasdi_keycloak_data_import:{{ sWasdiKeycloakRootDirectoryPath }}/{{ sWasdiKeycloakVersion }}/data/import:ro
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiKeycloakServiceName }}/opt_wasdi_keycloak_providers:{{ sWasdiKeycloakRootDirectoryPath }}/{{ sWasdiKeycloakVersion }}/providers:ro

  {{ sWasdiContainerPostgresqlKeycloakServiceName }}:
{% if bWasdiPostgresqlKeycloakInitialized == False %}
    environment:
      - POSTGRES_DB=${sPostgresqlKeycloakDatabaseName}
      - POSTGRES_USER=${sPostgresqlKeycloakDatabaseUsername}
      - POSTGRES_PASSWORD=${sPostgresqlKeycloakDatabasePassword}
      - POSTGRES_USER1_NAME=${sPostgresqlKeycloakUser1Name}
      - POSTGRES_USER1_PASSWORD=${sPostgresqlKeycloakUser1Password}
{% endif %}
    image: "{{ sWasdiContainerPostgresqlKeycloakImageName }}:{{ sWasdiContainerPostgresqlKeycloakImageVersion }}"
    restart: "unless-stopped"
    ulimits:
      nofile:
        soft: {{ sWasdiPostgresqlKeycloakUlimitNofile }}
        hard: {{ sWasdiPostgresqlKeycloakUlimitNofile }}
    volumes:
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiContainerPostgresqlKeycloakServiceName }}/data01:/var/lib/postgresql/data
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiContainerPostgresqlKeycloakServiceName }}/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro
{% endif %}

  # MongoDB
  {{ sWasdiMongoServiceName }}:
{% if ( sWasdiMongoInternalPort | default('') ) not in ['', '27017'] %}
    command:
      - "mongod"
      - "--port"
      - "{{ sWasdiMongoInternalPort }}"
    expose:
      - "{{ sWasdiMongoInternalPort }}"
{% endif %}
{% if bWasdiMongoInitialized == False %}
    environment:
      - MONGO_INITDB_DATABASE=${sWasdiMongoWasdiDatabaseName}
      - MONGO_INITDB_ROOT_PASSWORD=${sWasdiAdministratorPassword}
      - MONGO_INITDB_ROOT_USERNAME=${sWasdiAdministratorUsername}
      - sWasdiMongoAdditionalUserBackupUserName=${sWasdiMongoAdditionalUserBackupUserName}
      - sWasdiMongoAdditionalUserBackupUserPassword=${sWasdiMongoAdditionalUserBackupUserPassword}
{% if sWasdiServerTypeIsMain == True %}
      - sWasdiMongoEcostressDatabaseName=${sWasdiMongoEcostressDatabaseName}
      - sWasdiMongoEcostressUserName=${sWasdiMongoEcostressUserName}
      - sWasdiMongoEcostressUserPassword=${sWasdiMongoEcostressUserPassword}
      - sWasdiMongoModisDatabaseName=${sWasdiMongoModisDatabaseName}
      - sWasdiMongoModisUserName=${sWasdiMongoModisUserName}
      - sWasdiMongoModisUserPassword=${sWasdiMongoModisUserPassword}
{% endif %}
      - sWasdiMongoWasdiDatabaseName=${sWasdiMongoWasdiDatabaseName}
      - sWasdiMongoWasdiUserName=${sWasdiMongoWasdiUserName}
      - sWasdiMongoWasdiUserPassword=${sWasdiMongoWasdiUserPassword}
{% if sWasdiServerTypeIsMain == True %}
      - sWasdiMongoWasdiStatsDatabaseName=${sWasdiMongoWasdiStatsDatabaseName}
      - sWasdiMongoWasdiStatsUserName=${sWasdiMongoWasdiStatsUserName}
      - sWasdiMongoWasdiStatsUserPassword=${sWasdiMongoWasdiStatsUserPassword}
{% endif %}
{% endif %}
    image: "mongo:{{ sWasdiMongoVersion }}"
{% if sWasdiMongoInternalPort | default("") != ""
    and sWasdiMongoExternalPort | default("") != ""
    and aWasdiMongoExternalIp | default([]) | length > 0 %}
    ports:
{% for sCurrentExternalIp in aWasdiMongoContainerExternalIp | sort %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiMongoExternalPort }}:{{ sWasdiMongoInternalPort }}"
{% endfor %}
{% endif %}
    restart: "unless-stopped"
    ulimits:
      nofile:
        soft: {{ sWasdiMongoUlimitNofile }}
        hard: {{ sWasdiMongoUlimitNofile }}
    volumes:
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiMongoServiceName }}/data01:/data/db:rw
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiMongoServiceName }}/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro
{% if sWasdiServerTypeIsMain == True %}

  {{ sWasdiRabbitMqServiceName }}:
    depends_on:
      - {{ sWasdiTraefikServiceName }}
    environment:
      - RABBITMQ_CONFIG_FILE=/etc/rabbitmq/rabbitmq.conf
      - RABBITMQ_DISTRIBUTION_BUFFER_SIZE=128000
      - RABBITMQ_MNESIA_BASE=/var/lib/rabbitmq/mnesia/
      - RABBITMQ_NODENAME={{ sWasdiRabbitMqServiceName }}
      - RABBITMQ_NODE_PORT={{ sWasdiRabbitMqMainInternalPort }}
      - RABBITMQ_PID_FILE=/var/run/rabbitmq/rabbitmq.pid
    image: "{{ sWasdiRabbitMqServiceName }}:latest"
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.mw_{{ sWasdiRabbitMqServiceName }}.stripprefix.prefixes=/rabbit-stomp"
      - "traefik.http.middlewares.mw_{{ sWasdiRabbitMqServiceName }}.stripprefix.forceSlash=true"
      - "traefik.http.routers.r_{{ sWasdiRabbitMqServiceName }}.entrypoints={{ sWasdiContainerTraefikEntrypoint }}"
      - "traefik.http.routers.r_{{ sWasdiRabbitMqServiceName }}.rule=Host(`{{ sWasdiContainerTraefikRuleHost }}`) && PathPrefix(`/rabbit-stomp`)"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiRabbitMqServiceName }}.middlewares=mw_wasdi-secure-denyFrame@file"
{% endif %}
      - "traefik.http.routers.r_{{ sWasdiRabbitMqServiceName }}.service=s_{{ sWasdiRabbitMqServiceName }}"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiRabbitMqServiceName }}.tls=true"
{% endif %}
      - "traefik.http.routers.r_{{ sWasdiRabbitMqServiceName }}.middlewares=mw_{{ sWasdiRabbitMqServiceName }}@docker"
      - "traefik.http.services.s_{{ sWasdiRabbitMqServiceName }}.loadbalancer.server.port={{ sWasdiRabbitMqWebStompInternalPort }}"
{% if ( sWasdiRabbitMqMainInternalPort | default("") != "" or sWasdiRabbitMqWebStompInternalPort | default("") != "" )
    and ( sWasdiRabbitMqMainExternalPort | default("") != "" or sWasdiRabbitMqWebStompExternalPort | default("") != "" )
    and aWasdiRabbitMqExternalIp | default([]) | length > 0 %}
    ports:
{% if sWasdiRabbitMqMainInternalPort | default("") != ""
    and sWasdiRabbitMqMainExternalPort | default("") != "" %}
{% for sCurrentExternalIp in aWasdiRabbitMqExternalIp | sort %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiRabbitMqMainExternalPort }}:{{ sWasdiRabbitMqMainInternalPort }}"
{% endfor %}
{% endif %}
{% if sWasdiRabbitMqWebStompInternalPort | default("") != ""
    and sWasdiRabbitMqWebStompExternalPort | default("") != "" %}
{% for sCurrentExternalIp in aWasdiRabbitMqExternalIp | sort %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiRabbitMqWebStompExternalPort }}:{{ sWasdiRabbitMqWebStompInternalPort }}"
{% endfor %}
{% endif %}
{% endif %}
    restart: "unless-stopped"
    ulimits:
      nofile:
        soft: {{ sWasdiRabbitMqUlimitNofile }}
        hard: {{ sWasdiRabbitMqUlimitNofile }}
    volumes:
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiRabbitMqServiceName }}/data01:/var/lib/rabbitmq:rw
{% endif %}
{% if bWasdiSchedulerEnabled == True %}

  {{ sWasdiSchedulerServiceName }}:
    # Disable until we are ready to start all containers
    #depends_on:
#      - {{ sWasdiMongoServiceName }}
    image: "{{ sWasdiSchedulerServiceName }}:latest"
    restart: "unless-stopped"
    ulimits:
      nofile:
        soft: {{ sWasdiSchedulerUlimitNofile }}
        hard: {{ sWasdiSchedulerUlimitNofile }}
    volumes:
      - "{{ sWasdiDockerSocketFilePath }}:{{ sWasdiDockerSocketFilePath }}:ro"
      - "{{ sWasdiDataRootDirectoryPath }}:{{ sWasdiDataRootDirectoryPath }}:rw"
      - "{{ sWasdiDataConfigurationRootDirectoryPath }}:{{ sWasdiDataConfigurationRootDirectoryPath }}:ro"
{% endif %}
{% if bWasdiTomcatOgcProcessesServerEnabled == True %}

  {{ sWasdiContainerTomcatOgcProcessesServerServiceName }}:
    depends_on:
      - {{ sWasdiContainerGeoserverServiceName }}
      - {{ sWasdiKeycloakServiceName }}
      - {{ sWasdiMongoServiceName }}
      - {{ sWasdiRabbitMqServiceName }}
      - {{ sWasdiTraefikServiceName }}
    environment:
{% if sWasdiContainerTomcatOgcProcessesServerEnvironmentCatalinaOpts | default('') != '' %}
      - CATALINA_OPTS={{ sWasdiContainerTomcatOgcProcessesServerEnvironmentCatalinaOpts }}
{% endif %}
    image: "{{ sWasdiContainerTomcatOgcProcessesServerServiceName }}:latest"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatOgcProcessesServerServiceName }}.entrypoints={{ sWasdiContainerTraefikEntrypoint }}"
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatOgcProcessesServerServiceName }}.rule=Host(`{{ sWasdiContainerTraefikRuleHost }}`) && PathPrefix(`/ogcprocesses`)"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatOgcProcessesServerServiceName }}.middlewares=mw_wasdi-secure-denyFrame@file"
{% endif %}
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatOgcProcessesServerServiceName }}.service=s_{{ sWasdiContainerTomcatOgcProcessesServerServiceName }}"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatOgcProcessesServerServiceName }}.tls=true"
{% endif %}
      - "traefik.http.services.s_{{ sWasdiContainerTomcatOgcProcessesServerServiceName }}.loadbalancer.server.port={{ sWasdiContainerTomcatOgcProcessesServerInternalPort }}"
{% if sWasdiContainerTomcatOgcProcessesServerInternalPort | default("") != ""
    and sWasdiContainerTomcatOgcProcessesServerExternalPort | default("") != ""
    and aWasdiContainerTomcatOgcProcessesServerExternalIp | default([]) | length > 0 %}
    ports:
{% for sCurrentExternalIp in aWasdiContainerTomcatOgcProcessesServerExternalIp | sort %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiContainerTomcatOgcProcessesServerExternalPort }}:{{ sWasdiContainerTomcatOgcProcessesServerInternalPort }}"
{% endfor %}
{% endif %}
    restart: "unless-stopped"
    ulimits:
      nofile:
        soft: {{ sWasdiTomcatUlimitNofile }}
        hard: {{ sWasdiTomcatUlimitNofile }}
    volumes:
      - {{ sWasdiDataRootDirectoryPath }}:{{ sWasdiDataRootDirectoryPath }}:rw
      - {{ sWasdiDataConfigurationRootDirectoryPath }}:{{ sWasdiDataConfigurationRootDirectoryPath }}:ro
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiContainerGeoserverServiceName }}/data01/data:/mnt/data_{{ sWasdiContainerGeoserverServiceName }}:rw
{% endif %}
{% if bWasdiTomcatOpenEoServerEnabled == True %}

  {{ sWasdiContainerTomcatWasdiOpenEoServerServiceName }}:
    depends_on:
      - {{ sWasdiContainerGeoserverServiceName }}
      - {{ sWasdiKeycloakServiceName }}
      - {{ sWasdiMongoServiceName }}
      - {{ sWasdiRabbitMqServiceName }}
      - {{ sWasdiTraefikServiceName }}
    environment:
{% if sWasdiContainerTomcatWasdiOpenEoServerEnvironmentCatalinaOpts | default('') != '' %}
      - CATALINA_OPTS={{ sWasdiContainerTomcatWasdiOpenEoServerEnvironmentCatalinaOpts }}
{% endif %}
    image: "{{ sWasdiContainerTomcatWasdiOpenEoServerServiceName }}:latest"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatWasdiOpenEoServerServiceName }}.entrypoints={{ sWasdiContainerTraefikEntrypoint }}"
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatWasdiOpenEoServerServiceName }}.rule=Host(`{{ sWasdiContainerTraefikRuleHost }}`) && PathPrefix(`/wasdi-openeo-server`)"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatWasdiOpenEoServerServiceName }}.middlewares=mw_wasdi-secure-denyFrame@file"
{% endif %}
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatWasdiOpenEoServerServiceName }}.service=s_{{ sWasdiContainerTomcatWasdiOpenEoServerServiceName }}"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatWasdiOpenEoServerServiceName }}.tls=true"
{% endif %}
      - "traefik.http.services.s_{{ sWasdiContainerTomcatWasdiOpenEoServerServiceName }}.loadbalancer.server.port={{ sWasdiContainerTomcatWasdiOpenEoServerInternalPort }}"
{% if sWasdiContainerTomcatWasdiOpenEoServerInternalPort | default("") != ""
    and sWasdiContainerTomcatWasdiOpenEoServerExternalPort | default("") != ""
    and aWasdiContainerTomcatWasdiOpenEoServerExternalIp | default([]) | length > 0 %}
    ports:
{% for sCurrentExternalIp in aWasdiContainerTomcatWasdiOpenEoServerExternalIp | sort %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiContainerTomcatWasdiOpenEoServerExternalPort }}:{{ sWasdiContainerTomcatWasdiOpenEoServerInternalPort }}"
{% endfor %}
{% endif %}
    restart: "unless-stopped"
    ulimits:
      nofile:
        soft: {{ sWasdiTomcatUlimitNofile }}
        hard: {{ sWasdiTomcatUlimitNofile }}
    volumes:
      - {{ sWasdiDataRootDirectoryPath }}:{{ sWasdiDataRootDirectoryPath }}:rw
      - {{ sWasdiDataConfigurationRootDirectoryPath }}:{{ sWasdiDataConfigurationRootDirectoryPath }}:ro
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiContainerGeoserverServiceName }}/data01/data:/mnt/data_{{ sWasdiContainerGeoserverServiceName }}:rw
{% endif %}

  {{ sWasdiContainerTomcatWasdiWebServerServiceName }}:
    depends_on:
      - {{ sWasdiContainerGeoserverServiceName }}
{% if sWasdiServerTypeIsMain == True %}
      - {{ sWasdiKeycloakServiceName }}
{% endif %}
      - {{ sWasdiMongoServiceName }}
{% if sWasdiServerTypeIsMain == True %}
      - {{ sWasdiRabbitMqServiceName }}
{% endif %}
      - {{ sWasdiTraefikServiceName }}
    environment:
{% if sWasdiContainerTomcatWasdiWebServerEnvironmentCatalinaOpts | default('') != '' %}
      - CATALINA_OPTS={{ sWasdiContainerTomcatWasdiWebServerEnvironmentCatalinaOpts }}
{% endif %}
    image: "{{ sWasdiContainerTomcatWasdiWebServerServiceName }}:latest"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatWasdiWebServerServiceName }}.entrypoints={{ sWasdiContainerTraefikEntrypoint }}"
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatWasdiWebServerServiceName }}.rule=Host(`{{ sWasdiContainerTraefikRuleHost }}`) && PathPrefix(`/wasdiwebserver`)"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatWasdiWebServerServiceName }}.middlewares=mw_wasdi-secure-denyFrame@file"
{% endif %}
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatWasdiWebServerServiceName }}.service=s_{{ sWasdiContainerTomcatWasdiWebServerServiceName }}"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.r_{{ sWasdiContainerTomcatWasdiWebServerServiceName }}.tls=true"
{% endif %}
      - "traefik.http.services.s_{{ sWasdiContainerTomcatWasdiWebServerServiceName }}.loadbalancer.server.port={{ sWasdiContainerTomcatWasdiWebServerInternalPort }}"
{% if sWasdiContainerTomcatWasdiWebServerInternalPort | default("") != ""
    and sWasdiContainerTomcatWasdiWebServerExternalPort | default("") != ""
    and aWasdiContainerTomcatWasdiWebServerExternalIp | default([]) | length > 0 %}
    ports:
{% for sCurrentExternalIp in aWasdiContainerTomcatWasdiWebServerExternalIp | sort %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiContainerTomcatWasdiWebServerExternalPort }}:{{ sWasdiContainerTomcatWasdiWebServerInternalPort }}"
{% endfor %}
{% endif %}
    restart: "unless-stopped"
    ulimits:
      nofile:
        soft: {{ sWasdiTomcatUlimitNofile }}
        hard: {{ sWasdiTomcatUlimitNofile }}
    volumes:
      - {{ sWasdiDataRootDirectoryPath }}:{{ sWasdiDataRootDirectoryPath }}:rw
      - {{ sWasdiDataConfigurationRootDirectoryPath }}:{{ sWasdiDataConfigurationRootDirectoryPath }}:ro
      - {{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiContainerGeoserverServiceName }}/data01/data:/mnt/data_{{ sWasdiContainerGeoserverServiceName }}:rw

  {{ sWasdiTraefikServiceName }}:
    command:
      - "--global.sendanonymoususage=false"
      - "--api.dashboard=true"
#      - "--api.insecure=true"
      - "--entryPoints.web.address=:{{ sWasdiContainerTraefikHttpInternalPort }}"
      - "--entryPoints.web.forwardedHeaders.insecure"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "--entryPoints.websecure.address=:{{ sWasdiContainerTraefikHttpsInternalPort }}"
      - "--entryPoints.web.http.redirections.entrypoint.to=websecure"
      - "--entryPoints.web.http.redirections.entrypoint.scheme=https"
{% endif %}
      - "--log=true"
      - "--log.level=DEBUG"
      - "--log.format=common"
      - "--providers.docker=true"
      - "--providers.docker.endpoint={{ sWasdiContainerTraefikDockerEndpoint }}"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.watch=true"
      - "--providers.file.directory=/etc/traefik/conf.d"
      - "--providers.file.watch=true"
    image: "{{ sWasdiContainerTraefikImageName }}:{{ sWasdiContainerTraefikImageVersion }}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.entrypoints={{ sWasdiContainerTraefikEntrypoint }}"
      - "traefik.http.routers.dashboard.rule=Host(`{{ sWasdiContainerTraefikRuleHost }}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.dashboard.middlewares=mw_wasdi-secure-denyFrame@file"
{% endif %}
      - "traefik.http.routers.dashboard.service=api@internal"
{% if bWasdiContainerTraefikSslEnabled == True %}
      - "traefik.http.routers.dashboard.tls=true"
{% endif %}
{% if ( sWasdiContainerTraefikHttpInternalPort | default("") != ""
    and sWasdiContainerTraefikHttpExternalPort | default("") != ""
    and aWasdiContainerTraefikExternalIp | default([]) | length > 0 )
    or ( sWasdiContainerTraefikHttpsInternalPort | default("") != ""
    and sWasdiContainerTraefikHttpsExternalPort | default("") != ""
    and aWasdiContainerTraefikHttpsExternalIp | default([]) | length > 0 ) %}
    ports:
{% for sCurrentExternalIp in aWasdiContainerTraefikExternalIp | sort %}
{% if ( sWasdiContainerTraefikHttpInternalPort | default("") != ""
    and sWasdiContainerTraefikHttpExternalPort | default("") != ""
    and aWasdiContainerTraefikExternalIp | default([]) | length > 0 ) %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiContainerTraefikHttpExternalPort }}:{{ sWasdiContainerTraefikHttpInternalPort }}"
{% endif %}
{% if bWasdiContainerTraefikSslEnabled == True
    and sWasdiContainerTraefikHttpsInternalPort | default("") != ""
    and sWasdiContainerTraefikHttpsExternalPort | default("") != ""
    and aWasdiContainerTraefikExternalIp | default([]) | length > 0 %}
      - "{{ sCurrentExternalIp }}:{{ sWasdiContainerTraefikHttpsExternalPort }}:{{ sWasdiContainerTraefikHttpsInternalPort }}"
{% endif %}
{% endfor %}
{% endif %}
    restart: "unless-stopped"
    stdin_open: true
    tty: true
    user: "{{ sWasdiContainerTraefikUserName }}:{{ sWasdiContainerTraefikGroupName }}"
    ulimits:
      nofile:
        soft: {{ sWasdiTraefikUlimitNofile }}
        hard: {{ sWasdiTraefikUlimitNofile }}
    volumes:
      - "{{ sWasdiDockerSocketFilePath }}:{{ sWasdiDockerSocketFilePath }}:ro"
{% if bWasdiContainerTraefikSslSourceType | upper == 'MOUNT_EACH_FILE' %}
{% for aCurrentTraefikSslCertificate in aoWasdiContainerTraefikSslCertificates %}
      - "{{ aCurrentTraefikSslCertificate['srcCertFile'] }}:/etc/traefik/certs/{{ aCurrentTraefikSslCertificate['certFile'] }}:ro"
      - "{{ aCurrentTraefikSslCertificate['srcKeyFile'] }}:/etc/traefik/certs/{{ aCurrentTraefikSslCertificate['keyFile'] }}:ro"
{% endfor %}
{% else %}
      - "{{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiTraefikServiceName }}/etc_traefik_certs:/etc/traefik/certs:ro"
{% endif %}
      - "{{ sWasdiDataDockerVolumeRootDirectoryPath }}/{{ sWasdiTraefikServiceName }}/etc_traefik_conf.d:/etc/traefik/conf.d:ro"
{% if bWasdiComponentUpdateMetricEnabled == True %}

  {{ sWasdiContainerWasdiUpdateMetricServiceName }}:
    # Disable until we are ready to start all containers
    #depends_on:
    #  - {{ sWasdiKeycloakServiceName }}
    #  - {{ sWasdiContainerTomcatWasdiWebServerServiceName }}
    image: "{{ sWasdiContainerWasdiUpdateMetricServiceName }}:latest"
    restart: "unless-stopped"
    ulimits:
      nofile:
        soft: {{ sWasdiUpdateMetricUlimitNofile }}
        hard: {{ sWasdiUpdateMetricUlimitNofile }}
    volumes:
      - {{ sWasdiDataConfigurationRootDirectoryPath }}:{{ sWasdiDataConfigurationRootDirectoryPath }}:ro
      - {{ sWasdiDataPartitionRootDirectoryPath }}:{{ sWasdiDataPartitionRootDirectoryPath }}:ro
{% endif %}
